<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Echora Messenger</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  
  <style>
    :root { 
      --bg: #010c14; 
      --header: #0a1929; 
      --blue: #007aff; 
      --blue-light: #66b3ff;
      --own: #1a3a5a; 
      --other: #0f253e;
    }
    
    html, body { 
      margin: 0; 
      padding: 0; 
      width: 100%;
      height: 100vh; 
      height: -webkit-fill-available; 
      background: var(--bg); 
      font-family: sans-serif; 
      color: white; display: flex; 
      flex-direction: column; 
      overflow: hidden; 
      position: fixed; 
    }

    /* --- ALERT BANNER --- */
    #alert-banner { 
      background: var(--blue); 
      color: white; 
      padding: 10px 15px; 
      font-size: 0.85rem; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      z-index: 100; 
      flex-shrink: 0; 
    }

    /* --- CUSTOM DIALOGUE / POPUPS --- */
    #dialogue-overlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.8); 
      z-index: 5000; display: none; 
      align-items: center; 
      justify-content: center; 
    }

    .dialogue-box {
      font-size: large;
      background: var(--header); 
      width: 85%; max-width: 320px; 
      border-radius: 15px; 
      padding: 20px; border: 1px solid #334155;
      text-align: center; 
    }

    .dialogue-btn { 
      background: var(--blue);
      border: none; 
      padding: 10px 25px; 
      color: white; 
      border-radius: 8px; 
      font-weight: bold; 
      cursor: pointer; 
      margin-top: 15px; 
    }

    /* --- IMAGE PREVIEW MODAL --- */
    #img-modal { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.95); 
      z-index: 6000; 
      display: none; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
    }

    #img-modal img {
      max-width: 95%; 
      max-height: 80%; 
      border-radius: 10px; 
    }

    .modal-tools { 
      margin-top: 20px; 
      display: flex; 
      gap: 20px; 
    }

    .tool-btn { 
      background: #1e293b; 
      color: white; 
      border: none; 
      padding: 12px 20px; 
      border-radius: 10px; 
      cursor: pointer; 
      font-size: 18px; 
      display: flex; 
      align-items: center;
      gap: 10px;}

    /* --- DRAWER --- */
    #drawer { 
      position: fixed; 
      left: 0; 
      top: 0; 
      bottom: 0; 
      width: 260px; 
      background: var(--header); 
      z-index: 2500; 
      transform: translateX(-100%); 
      transition: 0.3s; 
      padding: 20px; 
      border-right: 1px solid #1a3a5a; 
    }

    #drawer.open { 
      transform: translateX(0); 
    }

    .overlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.6); 
      display: none; z-index: 2400; 
    }

    .overlay.open { 
      display: block; 
    }

    .nav-link { 
      display: block; 
      padding: 15px; 
      color: white; 
      text-decoration: none; 
      border-bottom: 1px solid #1a3a5a; 
      cursor: pointer; 
      border-radius: 8px; 
      margin-bottom: 5px; 
    }

    /* --- CONTEXT MENU (COPY/DELETE) --- */
    #context-menu { 
      position: fixed; 
      background: #1e293b; 
      border: 1px solid #334155; 
      border-radius: 10px; 
      padding: 5px; 
      display: none; 
      z-index: 4000; 
      flex-direction: column; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
    }

    .context-item { 
      padding: 12px 20px; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      font-size: 14px; 
    }

    .context-item:hover { 
      background: var(--blue); 
      border-radius: 5px; 
    }

    /* --- AUTH SCREEN --- */
    #auth-screen { 
      position: fixed; 
      inset: 0; 
      background: var(--bg); 
      z-index: 3000; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      padding: 20px; 
    }

    .auth-card { 
      background: var(--header); 
      padding: 25px; 
      border-radius: 15px; 
      width: 100%; 
      max-width: 350px; 
      text-align: center; 
      border: 1px solid #1a3a5a; 
    }

    .auth-logo { 
      font-size: 40px; 
      color: var(--blue); 
      margin-bottom: 10px; 
    }

    input { 
      width: 100%; 
      padding: 12px; 
      margin: 8px 0; 
      border-radius: 8px; 
      border: 1px solid #334155; 
      background: #1e293b; 
      color: white; 
      box-sizing: border-box; 
      font-size: 16px; 
    }

    /* --- CHAT UI --- */
    header { 
      height: 60px; 
      background: var(--header); 
      display: flex; 
      align-items: center; 
      padding: 0 15px; 
      border-bottom: 1px solid #1a3a5a; 
      justify-content: space-between; 
      flex-shrink: 0; 
    }

    header span { 
      color: var(--blue-light); 
    }

    #chat-box { 
      flex: 1; 
      overflow-y: auto; 
      padding: 15px; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      -webkit-overflow-scrolling: touch; 
    }
    
    .title{
      font-size: 18px; 
      color: var(--blue); 
      font-weight: bold;
    }
    .bubble { 
      max-width: 80%;
      padding:12px; 
      border-radius: 18px; 
      word-wrap: break-word; 
      font-size: 15px; 
      position: relative; 
      cursor: pointer; 
    }

    .bubble small { 
      color: var(--blue); 
      font-size: calc(15px + 2px); 
    }

    .own { 
      align-self: flex-end; 
      background: var(--own); 
      border-bottom-right-radius: 4px; 
    }

    .other { 
      align-self: flex-start; 
      background: var(--other); 
      border-bottom-left-radius: 4px; 
    }
    
    .system-msg { 
      align-self: center; 
      background: rgba(255, 255, 255, 0.05); 
      font-size: 0.75rem; 
      border-radius: 12px; 
      padding: 6px 16px; 
      color: #94a3b8; 
      margin: 5px 0; 
    }

    footer { 
      background: var(--header); 
      border-top: 1px solid #1a3a5a; 
      padding: 10px; 
      display: flex; 
      gap: 8px; 
      align-items: center; 
      flex-shrink: 0; 
      padding-bottom: calc(10px + env(safe-area-inset-bottom)); 
    }

    .btn-icon { 
      background: #1e293b; 
      border: 1px solid #334155; 
      color: white; 
      width: 45px; 
      height: 45px; 
      border-radius: 12px; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }

    .btn-send { 
      background: var(--blue); 
      border: none; 
      width: 45px; 
      height: 45px; 
      border-radius: 50%; 
      color: white; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }

    .hidden { 
      display: none !important; 
    }
  </style>
</head>
<body onclick="closeContext()">

<div id="img-modal">
  <img id="modal-img-src" src="">
  <div class="modal-tools">
    <button class="tool-btn" id="download-btn"><i class="fa-solid fa-download"></i></button>
    <button class="tool-btn" onclick="closeImgModal()"><i class="fa-solid fa-xmark"></i> Close</button>
  </div>
</div>

<div id="context-menu">
  <div class="context-item" id="copy-text-btn"><i class="fa-solid fa-copy"></i> Copy Text</div>
  <div class="context-item" id="delete-msg-btn" style="color:#f87171;"><i class="fa-solid fa-trash"></i> Delete</div>
</div>

<div id="dialogue-overlay">
  <div class="dialogue-box">
    <h3 id="diag-title">Notice</h3>
    <p id="diag-text"></p>
    <button class="dialogue-btn" onclick="closeDialogue()">OK</button>
  </div>
</div>

<div class="overlay" onclick="toggleDrawer()"></div>
<div id="drawer">
  <h2 style="color:var(--blue);">Echora</h2>
  <div class="nav-link" style="color: #007aff;" onclick="toggleDrawer()">üè† Home</div>
  <div class="nav-link" style="color: #007aff;" onclick="showDialogue('About', 'Echora messenger v3.1\n~by Kmrxz\n\nAll systems active')">‚ÑπÔ∏è About</div>
  <div class="nav-link" onclick="logout()" style="color:#f87171; margin-top: 20px;">üö™ Logout</div>
</div>

<div id="alert-banner">
  <span><i class="fa-solid fa-circle-info"></i> Be respectful and kind to others.</span>
  <i class="fa-solid fa-xmark" onclick="hideBanner()"></i>
</div>

<div id="auth-screen">
  <div class="auth-card" id="login-box">
    <div class="auth-logo"><i class="fa-solid fa-right-to-bracket"></i></div>
    <h2>Login</h2>
    <input type="text" id="l-user" placeholder="Username">
    <input type="password" id="l-pin" maxlength="4" placeholder="PIN">
    <button class="dialogue-btn" style="width:100%" onclick="doAuth('login')">Login</button>
    <p onclick="toggleAuth()" style="cursor:pointer; color:var(--blue); margin-top:15px; font-size:0.8rem;">Create Account</p>
  </div>
  <div class="auth-card hidden" id="signup-box">
    <div class="auth-logo"><i class="fa-solid fa-user-plus"></i></div>
    <h2>Sign Up</h2>
    <input type="text" id="s-user" placeholder="Username">
    <input type="password" id="s-pin" maxlength="4" placeholder="4-digit PIN">
    <button class="dialogue-btn" style="width:100%" onclick="doAuth('signup')">Join</button>
    <p onclick="toggleAuth()" style="cursor:pointer; color:var(--blue); margin-top:15px; font-size:0.8rem;">Back to Login</p>
  </div>
</div>

<header>
  <span onclick="toggleDrawer()" style="font-size:24px; cursor:pointer">‚ò∞</span>
  <b class="title">Echora chat</b>
  <div style="width:24px"></div>
</header>

<div id="chat-box"></div>

<footer>
  <input type="file" id="file-input" class="hidden" onchange="upload(this)" accept="image/*">
  <button class="btn-icon" onclick="document.getElementById('file-input').click()"><i class="fa-solid fa-plus"></i></button>
  <input type="text" id="msg-input" placeholder="Message...">
  <button class="btn-send" onclick="send()"><i class="fa-solid fa-paper-plane"></i></button>
</footer>

<script>
  const client = supabase.createClient("https://sbggyupgkavhkafqapie.supabase.co", "sb_publishable_8C0U6Mj4WDuuPeqHJJGS1w_BTNtiFtb");
  let user = JSON.parse(localStorage.getItem("kmr_user"));
  let currentSelection = { id: null, content: null };

  if (user) { document.getElementById('auth-screen').classList.add('hidden'); init(); }

  // --- UI CONTROLS ---
  function toggleDrawer() { document.getElementById('drawer').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('open'); }
  function showDialogue(t, tx) { document.getElementById('diag-title').innerText = t; document.getElementById('diag-text').innerText = tx; document.getElementById('dialogue-overlay').style.display = 'flex'; }
  function closeDialogue() { document.getElementById('dialogue-overlay').style.display = 'none'; }
  function hideBanner() { 
    const b = document.getElementById('alert-banner'); 
    b.classList.add('hidden'); 
    try { localStorage.setItem('kmr_banner_dismissed','1'); } catch(e){}
    if (window._kmr_banner_timeout) { clearTimeout(window._kmr_banner_timeout); window._kmr_banner_timeout = null; }
  }

  function showBannerTemporarily(ms = 9000) {
    try { if (localStorage.getItem('kmr_banner_dismissed') === '1') return; } catch(e){}
    const b = document.getElementById('alert-banner');
    b.classList.remove('hidden');
    if (window._kmr_banner_timeout) clearTimeout(window._kmr_banner_timeout);
    window._kmr_banner_timeout = setTimeout(() => {
      b.classList.add('hidden');
      try { localStorage.setItem('kmr_banner_dismissed','1'); } catch(e){}
      window._kmr_banner_timeout = null;
    }, ms);
  }
  function toggleAuth() { document.getElementById('login-box').classList.toggle('hidden'); document.getElementById('signup-box').classList.toggle('hidden'); }

  // --- IMAGE PREVIEW ---
  function openImgModal(src) {
    document.getElementById('modal-img-src').src = src;
    document.getElementById('img-modal').style.display = 'flex';
    document.getElementById('download-btn').onclick = () => {
      const a = document.createElement('a'); a.href = src; a.download = 'echora_img.jpg'; a.click();
    };
  }
  function closeImgModal() { document.getElementById('img-modal').style.display = 'none'; }

  // --- CONTEXT MENU (COPY/DELETE) ---
  function showContext(e, id, text, sender) {
    e.preventDefault();
    currentSelection = { id, content: text };
    const menu = document.getElementById('context-menu');
    menu.style.display = 'flex';
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
    
    // Only show delete if the user is the sender
    document.getElementById('delete-msg-btn').style.display = (sender === user.username) ? 'flex' : 'none';
    
    document.getElementById('copy-text-btn').onclick = () => {
      navigator.clipboard.writeText(text); closeContext();
    };
    document.getElementById('delete-msg-btn').onclick = async () => {
      await client.from('messages').delete().eq('id', id); closeContext(); load();
    };
  }
  function closeContext() { document.getElementById('context-menu').style.display = 'none'; }

  // --- AUTH ---
  async function doAuth(type) {
    const u = document.getElementById(type==='login'?'l-user':'s-user').value.trim();
    const p = document.getElementById(type==='login'?'l-pin':'s-pin').value.trim();
    if (type === 'signup') {
      const { data, error } = await client.from('profiles').insert([{ username: u, pin: p, phone: 'U'+Date.now() }]).select();
      if (error) return showDialogue("Error", "Username taken.");
      user = data[0];
      await client.from('messages').insert([{ sender: 'System', content: `${u} joined the chat`, is_system: true }]);
    } else {
      const { data } = await client.from('profiles').select('*').eq('username', u).maybeSingle();
      if (data && data.pin == p) user = data; else return showDialogue("Error", "Wrong Login.");
    }
    localStorage.setItem("kmr_user", JSON.stringify(user));
    location.reload();
  }

  function init() {
    load();
    client.channel('room1').on('postgres_changes', {event:'*', schema:'public', table:'messages'}, load).subscribe();
  }

  async function load() {
    const { data } = await client.from('messages').select('*').order('created_at', {ascending:true});
    const box = document.getElementById('chat-box');

    box.innerHTML = data.map(m => {
      if (m.is_system) return `<div class="system-msg">${m.content}</div>`;
      const isImg = m.content.includes('supabase.co/storage');
      return `<div class="bubble ${m.sender === user.username ? 'own' : 'other'}" 
                 oncontextmenu="showContext(event, ${m.id}, '${m.content.replace(/'/g, "\\'")}', '${m.sender}')"
                 onclick="${isImg ? `openImgModal('${m.content}')` : ''}">
                <small>${m.sender}</small><br>
                ${isImg ? `<img src="${m.content}" style="max-width:100%; border-radius:10px; margin-top:5px;">` : m.content}
              </div>`;
    }).join('');
    box.scrollTop = box.scrollHeight;
  }

  async function send() {
    const inp = document.getElementById('msg-input');
    if (!inp.value.trim()) return;
    await client.from('messages').insert([{ sender: user.username, content: inp.value, is_system: false }]);
    // hide banner when user sends message (persisted)
    hideBanner();
    inp.value = ''; inp.focus();
  }

  async function upload(el) {
    const file = el.files[0];
    const path = `uploads/${Date.now()}_${file.name}`;
    await client.storage.from('chat-files').upload(path, file);
    const { data } = client.storage.from('chat-files').getPublicUrl(path);
    await client.from('messages').insert([{ sender: user.username, content: data.publicUrl, is_system: false }]);
    // hide banner on first upload/send
    hideBanner();
  }

  function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>