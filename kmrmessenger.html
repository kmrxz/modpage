<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Echora Messenger</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <style>
    :root { --bg: #010c14; --header: #0a1929; --blue: #007aff; --own: #1a3a5a; --other: #0f253e; }
    
    html, body { 
      margin: 0; padding: 0; width: 100%; height: 100%; 
      background: var(--bg); font-family: sans-serif; color: white; 
      display: flex; flex-direction: column; overflow: hidden;
      position: fixed;
    }

    /* Navigation Drawer */
    #drawer { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; background: var(--header); z-index: 2500; transform: translateX(-100%); transition: 0.3s; padding: 20px; border-right: 1px solid #1a3a5a; }
    #drawer.open { transform: translateX(0); }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; z-index: 2400; }
    .overlay.open { display: block; }
    .nav-link { display: block; padding: 15px; color: white; text-decoration: none; border-bottom: 1px solid #1a3a5a; cursor: pointer; border-radius: 8px; margin-bottom: 5px; }

    /* Auth Screens */
    #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .card { background: var(--header); padding: 25px; border-radius: 15px; width: 100%; max-width: 350px; text-align: center; border: 1px solid #1a3a5a; }
    input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; box-sizing: border-box; font-size: 16px; }

    /* Main UI Layout */
    header { height: 60px; background: var(--header); display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid #1a3a5a; justify-content: space-between; flex-shrink: 0; }
    #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; -webkit-overflow-scrolling: touch; }
    
    .bubble { max-width: 80%; padding: 12px; border-radius: 18px; position: relative; word-wrap: break-word; }
    .own { align-self: flex-end; background: var(--own); border-bottom-right-radius: 4px; }
    .other { align-self: flex-start; background: var(--other); border-bottom-left-radius: 4px; }
    .system-msg { align-self: center; background: rgba(255,255,255,0.1); font-size: 0.75rem; border-radius: 20px; padding: 5px 15px; color: #94a3b8; margin: 10px 0; }
    
    /* Media fix */
    .chat-img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; border: 1px solid rgba(255,255,255,0.1); }

    footer { background: var(--header); border-top: 1px solid #1a3a5a; padding: 10px; display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
    .msg-input-field { flex: 1; margin: 0; }
    .btn-icon { background: #1e293b; border: 1px solid #334155; color: white; width: 45px; height: 45px; border-radius: 12px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .btn-send { background: var(--blue); border: none; padding: 10px 20px; border-radius: 12px; color: white; cursor: pointer; font-weight: bold; flex-shrink: 0; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="overlay" onclick="toggleDrawer()"></div>
<div id="drawer">
  <h2 style="color:var(--blue); margin-bottom:30px;">Echora</h2>
  <div class="nav-link" onclick="toggleDrawer()">üè† Home</div>
  <div class="nav-link" onclick="alert('Echora v2.5\nMedia Support Enabled')">‚ÑπÔ∏è About</div>
  <div class="nav-link" onclick="logout()" style="color:#f87171; margin-top: 20px;">üö™ Logout</div>
</div>

<div id="auth-screen">
  <div class="card" id="login-box">
    <h2 style="color:var(--blue)">Echora Login</h2>
    <input type="text" id="login-username" placeholder="Username">
    <input type="password" id="login-pin" maxlength="4" placeholder="4-Digit PIN">
    <button class="btn-send" style="width:100%" onclick="handleLogin()">Login</button>
    <p onclick="showSignup()" style="cursor:pointer; color:var(--blue); font-size:0.8rem; margin-top:15px;">Need an account? Sign Up</p>
  </div>
  <div class="card hidden" id="signup-box">
    <h2>Create Account</h2>
    <input type="text" id="signup-username" placeholder="Username">
    <input type="password" id="signup-pin" maxlength="4" placeholder="4-Digit PIN">
    <button class="btn-send" style="width:100%" onclick="finishSignUp()">Create Account</button>
    <p onclick="showLogin()" style="cursor:pointer; color:var(--blue); font-size:0.8rem; margin-top:15px;">Back to Login</p>
  </div>
</div>

<header>
  <span onclick="toggleDrawer()" style="font-size:24px; cursor:pointer">‚ò∞</span>
  <b>Echora Messenger</b>
  <div style="width:24px"></div>
</header>

<div id="chat-box"></div>

<footer>
  <input type="file" id="file-input" class="hidden" onchange="uploadFile(this)" accept="image/*">
  <button class="btn-icon" onclick="document.getElementById('file-input').click()">+</button>
  <input type="text" id="msg-input" class="msg-input-field" placeholder="Message...">
  <button class="btn-send" onclick="send()">Send</button>
</footer>

<script>
  const SUPABASE_URL = "https://sbggyupgkavhkafqapie.supabase.co";
  const SUPABASE_KEY = "sb_publishable_8C0U6Mj4WDuuPeqHJJGS1w_BTNtiFtb";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let user = JSON.parse(localStorage.getItem("kmr_user")) || null;
  if (user) { document.getElementById('auth-screen').classList.add('hidden'); init(); }

  // Keyboard/Viewport Fix
  const handleViewportChange = () => {
    const viewport = window.visualViewport;
    document.body.style.height = viewport.height + 'px';
    window.scrollTo(0, 0);
    const box = document.getElementById('chat-box');
    box.scrollTop = box.scrollHeight;
  };

  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', handleViewportChange);
  }

  function toggleDrawer() {
    document.getElementById('drawer').classList.toggle('open');
    document.querySelector('.overlay').classList.toggle('open');
  }

  function showSignup() { document.getElementById('login-box').classList.add('hidden'); document.getElementById('signup-box').classList.remove('hidden'); }
  function showLogin() { document.getElementById('signup-box').classList.add('hidden'); document.getElementById('login-box').classList.remove('hidden'); }
  function logout() { localStorage.clear(); location.reload(); }

  async function handleLogin() {
    const u = document.getElementById('login-username').value.trim();
    const p = document.getElementById('login-pin').value.trim();
    const { data } = await client.from('profiles').select('*').eq('username', u).maybeSingle();
    if (data && String(data.pin) === String(p)) {
      user = data; localStorage.setItem("kmr_user", JSON.stringify(user)); location.reload();
    } else { alert("Login failed."); }
  }

  async function finishSignUp() {
    const u = document.getElementById('signup-username').value.trim();
    const p = document.getElementById('signup-pin').value.trim();
    const { data, error } = await client.from('profiles').insert([{ username: u, pin: p, phone: "U_" + Date.now() }]).select();
    if (error) return alert("Username taken!");
    user = data[0]; localStorage.setItem("kmr_user", JSON.stringify(user)); location.reload();
  }

  function init() {
    load();
    client.channel('public:messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, load).subscribe();
  }

  async function load() {
    const { data } = await client.from('messages').select('*').order('created_at', { ascending: true });
    if (!data) return;
    const box = document.getElementById('chat-box');
    const hasReal = data.some(m => !m.is_system);
    
    box.innerHTML = data.filter(m => !m.is_system || !hasReal).map(m => {
      if (m.is_system) return `<div class="system-msg">${m.content}</div>`;
      
      // MEDIA CHECK: Check if the content is a image link from Supabase
      const isImg = (m.content || '').includes('supabase.co/storage/v1/object/public/');
      
      return `<div class="bubble ${m.sender === user.username ? 'own' : 'other'}">
                <small style="opacity:0.6; font-size:0.65rem">${m.sender}</small><br>
                ${isImg ? `<img src="${m.content}" class="chat-img" onclick="window.open('${m.content}')">` : m.content}
              </div>`;
    }).join('');
    box.scrollTop = box.scrollHeight;
  }

  async function send() {
    const inp = document.getElementById('msg-input');
    if (!inp.value.trim()) return;
    await client.from('messages').insert([{ sender: user.username, content: inp.value.trim(), is_system: false }]);
    inp.value = '';
    inp.focus();
  }

  async function uploadFile(input) {
    const file = input.files[0];
    if (!file) return;
    
    // Ensure you have a bucket named 'chat-files' in Supabase Storage
    const path = `uploads/${Date.now()}_${file.name}`;
    const { error: upErr } = await client.storage.from('chat-files').upload(path, file);
    
    if (upErr) return alert("Upload failed: " + upErr.message);
    
    const { data } = client.storage.from('chat-files').getPublicUrl(path);
    await client.from('messages').insert([{ sender: user.username, content: data.publicUrl, is_system: false }]);
  }
</script>
</body>
</html>