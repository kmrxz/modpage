<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Echora Messenger</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <style>
    :root { --bg: #010c14; --header: #0a1929; --blue: #007aff; --own: #1a3a5a; --other: #0f253e; }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: var(--bg); font-family: sans-serif; color: white; display: flex; flex-direction: column; overflow: hidden; 
      user-select: none; -webkit-user-select: none; }

    /* Ergonomic Viewer - Buttons at Bottom */
    #image-viewer { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
    #viewer-img { max-width: 100%; max-height: 75vh; object-fit: contain; }
    .viewer-footer { position: absolute; bottom: 0; left: 0; width: 100%; height: 120px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); display: flex; justify-content: space-around; align-items: center; padding-bottom: 30px; }
    .v-btn { background: var(--blue); border: none; color: white; padding: 15px 30px; border-radius: 12px; font-weight: bold; font-size: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .close-btn { background: #334155; }

    /* Drawer Styles */
    #drawer { position: fixed; left: -280px; top: 0; bottom: 0; width: 280px; background: var(--header); z-index: 9001; transition: transform 0.3s ease; padding: 25px; border-right: 1px solid #1a3a5a; }
    #drawer.open { transform: translateX(280px); }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; z-index: 9000; }
    .overlay.open { display: block; }
    .drawer-link { display: block; padding: 15px; color: #94a3b8; text-decoration: none; border-bottom: 1px solid #1a3a5a; font-weight: 500; }

    /* Message Styles */
    #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    .bubble { max-width: 85%; padding: 12px; border-radius: 18px; position: relative; }
    .own .bubble { background: var(--own); align-self: flex-end; border-bottom-right-radius: 4px; }
    .other .bubble { background: var(--other); align-self: flex-start; border-bottom-left-radius: 4px; }
    .time { font-size: 0.65rem; color: #64748b; margin-top: 5px; display: block; text-align: right; }
    .chat-img { max-width: 100%; border-radius: 10px; margin: 5px 0; display: block; }
    
    /* Input Area */
    footer { background: var(--header); padding: 10px; display: flex; gap: 8px; border-top: 1px solid #1a3a5a; }
    input#msg-input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #334155; background: #1e293b; color: white; font-size: 16px; outline: none; user-select: text !important; -webkit-user-select: text !important; }
    
    .img-del-container { text-align: right; width: 100%; }
    .direct-del { color: #f87171; font-size: 0.7rem; background: none; border: none; padding: 5px; cursor: pointer; }
  </style>
</head>
<body>

<div id="image-viewer">
  <img id="viewer-img">
  <div class="viewer-footer">
    <button class="v-btn close-btn" onclick="closeViewer()">‚úï Close</button>
    <button class="v-btn" id="dl-btn">‚Üì Download</button>
  </div>
</div>

<div class="overlay" onclick="toggleDrawer()"></div>
<div id="drawer">
  <h2 style="color:var(--blue)">Echora</h2>
  <a href="index.html" target="_blank" class="drawer-link">üè† Home</a>
  <a href="about.html" class="drawer-link">‚ÑπÔ∏è About</a>
  <div onclick="logout()" class="drawer-link" style="color:#f87171; cursor:pointer;">Logout</div>
</div>

<header style="height:60px; background:var(--header); display:flex; align-items:center; padding:0 15px; justify-content:space-between;">
  <div onclick="toggleDrawer()" style="font-size:24px;">‚ò∞</div>
  <b style="letter-spacing:2px">ECHORA</b>
  <div style="width:24px"></div>
</header>

<div id="chat-box"></div>

<footer>
  <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; color:white; font-size:24px;">+</button>
  <input type="file" id="file-input" style="display:none" onchange="upload(this)">
  <input type="text" id="msg-input" placeholder="Message...">
  <button onclick="send()" style="background:var(--blue); border:none; border-radius:50%; width:40px; height:40px; color:white;">‚û§</button>
</footer>

<script>
  // ... Paste your Supabase credentials here ...
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  let user = JSON.parse(localStorage.getItem("kmr_user"));

  function toggleDrawer() {
    document.getElementById('drawer').classList.toggle('open');
    document.querySelector('.overlay').classList.toggle('open');
  }

  function openViewer(url) {
    document.getElementById('viewer-img').src = url;
    document.getElementById('image-viewer').style.display = 'flex';
    document.getElementById('dl-btn').onclick = async () => {
       const blob = await (await fetch(url)).blob();
       const a = document.createElement('a');
       a.href = URL.createObjectURL(blob);
       a.download = "Echora_" + Date.now() + ".jpg";
       a.click();
    };
  }

  function closeViewer() { document.getElementById('image-viewer').style.display = 'none'; }

  async function load() {
    const { data } = await client.from('messages').select('*').order('created_at', { ascending: true });
    const box = document.getElementById('chat-box');
    box.innerHTML = '';
    data?.forEach(m => {
      const isOwn = m.sender_phone === user.phone;
      const isImg = m.content.includes('http') && m.content.match(/\.(jpg|png|webp|jpeg)/i);
      const time = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      const div = document.createElement('div');
      div.className = `msg-wrapper ${isOwn ? 'own' : 'other'}`;
      div.style.display = 'flex';
      div.style.flexDirection = 'column';

      div.innerHTML = `
        <div class="bubble">
          <small style="color:var(--blue)">${m.sender}</small><br>
          ${isImg ? `<img src="${m.content}" class="chat-img" onclick="openViewer('${m.content}')">` : m.content}
          <span class="time">${time}</span>
        </div>
        ${(isImg && isOwn) ? `<div class="img-del-container"><button class="direct-del" onclick="del('${m.id}')">Delete for all</button></div>` : ''}
      `;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  }

  async function del(id) { if(confirm("Delete?")) await client.from('messages').delete().eq('id', id); }

  // Initial load and Real-time listener
  if(user) {
    load();
    client.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, load).subscribe();
  }
</script>
</body>
</html>
