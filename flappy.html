<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>The Kenthan Game</title>
  <style>
    html,body{height:100%;margin:0}
    body{display:flex;align-items:center;justify-content:center;background:#081025;color:#cfe0ff;font-family:Arial}
    #game{background:linear-gradient(#07131a,#04202a);display:block;border-radius:8px;box-shadow:0 12px 32px rgba(0,0,0,0.6)}
    .hud{position:fixed;left:20px;top:20px;color:#bfe6c3;font-weight:700}
    .center-msg{position:absolute;left:50%;top:40%;transform:translate(-50%,-50%);color:#fff;text-align:center}
    button{cursor:pointer}
    :root{--hover-speed:600ms}
    /* Button base styling and hover animation (inner span used so JS can animate outer transform) */
    .btn-base{border-radius:8px;border:none;padding:8px 12px;background:#2c41b8;color:#50a9d3;display:inline-block;transform-origin:center;outline:none}
    .btn-base .btn-inner{display:inline-block;transition:transform var(--hover-speed) ease, box-shadow var(--hover-speed) ease;transform-origin:center}
    .btn-base:hover .btn-inner{transform:translateY(-6px) scale(1.03);box-shadow:0 12px 24px rgba(0,0,0,0.35)}
    /* make different colored buttons inherit base then override colors inline or via existing style attrs */
    /* highlight styles for latest score */
    .score-highlight{color:cyan !important;font-weight:800;transition:color 300ms ease, transform 300ms ease;transform-origin:center}
    .overlay-latest{color:cyan;font-weight:800}
    /* Responsive overlay buttons */
    .overlay-buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .overlay-buttons button{min-width:96px;padding:8px 10px}
    @media(max-width:420px){
      .overlay-buttons{gap:6px}
      .overlay-buttons button{min-width:44%;font-size:14px}
      #player-name{min-width:160px}
    }
  </style>
</head>
<body>
  <!-- Background music (off by default) -->
  <audio id="bgMusic" src="files/audio/kenthan theme.mp3" loop></audio>
  <!-- Hit sound -->
  <audio id="hitSnd" src="Sounds/blast.wav"></audio>
  <!-- Click/coin sound played on every click/flap -->
  <audio id="coin" src="Sounds/coin.mp3"></audio>
  <!-- Tap sound for flap/tap (replaces previous tapping sound) -->
  <audio id="tapSnd" src="Sounds/wind.mp3"></audio>
  <!-- Button click sounds -->
  <audio id="btnStartSnd" src="files/audio/ui-button-click-5-327756.mp3"></audio>
  <audio id="btnOtherSnd" src="file:///C:/Users/Admin/modpage/files/audio/button-click-289742.mp3"></audio>
  <button id="music-toggle" style="position:fixed;right:16px;top:16px;z-index:1200;padding:8px 10px;border-radius:8px;border:none;background:#0c6f46;color:#fff;cursor:pointer">Pause Music</button>
  <button id="clear-cache-btn" style="position:fixed;right:16px;top:56px;z-index:1200;padding:8px 10px;border-radius:8px;border:none;background:mediumseagreen;color:#fff;cursor:pointer">Clear cache</button>

  <canvas id="game" width="480" height="640"></canvas>
  <div class="hud">Score: <span id="score">0</span></div>
  <div id="overlay" class="center-msg" style="display:flex;flex-direction:column;align-items:center;gap:12px;">
    <img id="overlay-bird" src="files/img/kenthan.png" alt="bird" style="width:96px;height:auto;display:block;">
    <h1 style="margin:0;text-shadow: 1px 1px 2px #04202a;font-size:28px;letter-spacing:1px;color:rgb(28, 136, 136)">Flappy Kenthan</h1>
    <p id="overlay-sub" style="margin:6px 0 0 0;text-shadow: 1px 1px 2px #04202a;color:#9c8adf">Version 1.0</p>
    <input id="player-name" placeholder="Enter name (optional)" style="padding:8px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.02);color:#fff;outline:none;min-width:220px;text-align:center">
    <div class="overlay-buttons" style="margin-top:6px;width:100%;justify-content:center">
      <button id="action-btn" style="border-radius:8px;border:none;background:#2c41b8;color:#80ddd5;padding:10px 18px;min-width:140px">START</button>
      <button id="submit-score-btn" style="border-radius:8px;border:none;background:#b76b00;color:#fff;">Submit Score</button>
    </div>
    <!-- Hidden form for score submission (auto-filled) -->
    <form id="score-form" action="https://formsubmit.co/akshaydj56774@gmail.com" method="POST" style="display:none">
      <input type="hidden" name="name" id="form-name">
      <input type="hidden" name="highscore" id="form-highscore">
      <input type="hidden" name="_next" value="https://kmrxz.github.io/modpage/flappy.html">
      <input type="hidden" name="_captcha" value="false">
      <input type="hidden" name="_autoresponse" value="Your high score will be updated to the leaderboard shortly,kmrxz is still learning live database">
    </form>
      <div id="leaderboard" style="display:none;margin-top:12px;max-height:220px;overflow:auto;background:rgba(0,0,0,0.25);padding:10px;border-radius:8px;min-width:260px">
      <strong style="display:block;margin-bottom:8px;font-size:18px;color:#e6fff2">Leaderboard</strong>
      <ol id="leaderboard-list" style="margin:0 0 0 18px;padding:0;color:#e6fff2"></ol>
    </div>
    <!-- bottom controls (Home + How to play?) shown only on start and end screens -->
    <div id="bottom-controls" style="display:flex;gap:8px;margin-top:10px">
      <button id="howto-btn" style="border-radius:8px;border:none;background:#445db1;color:#fff;padding:8px 12px">How to play?</button>
      <button id="home-btn" style="border-radius:8px;border:none;background:#6655af;color:#fff;padding:8px 12px">GO Home</button>
    </div>
    <!-- How to play dialog -->
    <div id="howto-dialog" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(4,32,42,0.98);color:#dff6e8;padding:18px;border-radius:10px;width:90%;max-width:720px;z-index:2000">
      <h3 style="margin-top:0;color:#1d745a">HOW TO PLAY?</h3>
      <p style="color:#dff6e8;font-size:15px;line-height:1.4;white-space:normal;word-break:normal">Kenthan was at work and asked to go On-duty to buy green pipes but fell into Green pipe factory container. Help him go back to his work before Shammi notices</p>
      <p style="color:#c52e2e;font-size:15px;line-height:1.4;white-space:normal;word-break:normal">>> Dont hit the pipes <br>>> Pass pipes to get 1 allowance each <br>>> Collect coins to get 5 Allowance  <br>>> Meet final boss</p>
      <p style="color:#dff6e8;font-size:15px;line-height:1.4;white-space:normal;word-break:normal">Tap on the screen or press Space to make Kenthan flap</p>
      <div style="text-align:right;margin-top:12px"><button id="understood-btn" style="padding:8px 12px;border-radius:8px;border:none;background:#0c6f46;color:#fff">Understood!</button></div>
    </div>
  </div>
  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;

    // Bird image (use provided path)
    const birdImg = new Image();
    const defaultBirdSrc = 'files/img/kenthan.png';
    const blastBirdSrc = 'files/img/blast.png';
    birdImg.src = defaultBirdSrc;
    let birdLoaded = false;
    birdImg.onload = () => birdLoaded = true;
    // explosion image (same asset) and active explosion state
    const explosionImg = new Image();
    explosionImg.src = blastBirdSrc;
    let explosionImgLoaded = false;
    explosionImg.onload = () => explosionImgLoaded = true;
    let explosion = null; // {x,y,created,ttl}
    // moving clouds (background) - use files/img/cloud 1.png and files/img/cloud 2.png
    const cloudImgs = [new Image(), new Image()];
    cloudImgs[0].src = 'files/img/cloud 1.png';
    cloudImgs[1].src = 'files/img/cloud 2.png';
    const clouds = [];
    function initClouds(){
      clouds.length = 0;
      const count = 4;
      for (let i = 0; i < count; i++){
        const img = cloudImgs[Math.floor(Math.random() * cloudImgs.length)];
        const w = 220 + Math.floor(Math.random() * 200);
        const h = Math.floor(w * 0.45);
        const x = Math.random() * W;
        const y = 20 + Math.random() * 220;
        const speed = 0.2 + Math.random() * 0.9 + (i * 0.06);
        const alpha = 0.55 + Math.random() * 0.35;
        clouds.push({img, x, y, w, h, speed, alpha});
      }
    }
    initClouds();
    // grass on ground
    const grassImgs = [new Image(), new Image()];
    grassImgs[0].src = 'files/img/grass 1.png';
    grassImgs[1].src = 'files/img/grass 2.png';
    const grasses = [];
    function initGrass(){
      grasses.length = 0;
      const count = Math.max(4, Math.floor(W / 90));
      for (let i = 0; i < count; i++){
        const img = grassImgs[Math.floor(Math.random() * grassImgs.length)];
        const w = 48 + Math.floor(Math.random() * 80); // 48..128
        const h = Math.floor(w * 0.45);
        const x = Math.random() * W;
        const y = H - 20 - h + (Math.random() * 6 - 3);
        const speedFactor = 0.9 + Math.random() * 0.3;
        grasses.push({img, x, y, w, h, speedFactor});
      }
    }
    initGrass();
    // audio elements
    const bgMusic = document.getElementById('bgMusic');
    const hitSnd = document.getElementById('hitSnd');
    const coinSnd = document.getElementById('coin');
    const tapSnd = document.getElementById('tapSnd');
    const musicToggle = document.getElementById('music-toggle');
    const clearCacheBtn = document.getElementById('clear-cache-btn');
    let musicEnabled = false; // keep off by default
    if (bgMusic) { bgMusic.volume = 0.5; try{ bgMusic.play().catch(()=>{}); }catch(e){} }
    if (musicToggle){
      // start with music playing by default
      musicEnabled = true;
      musicToggle.addEventListener('click', ()=>{
        musicEnabled = !musicEnabled;
        if (musicEnabled){ bgMusic.play().catch(()=>{}); musicToggle.textContent = 'Pause Music'; }
        else { bgMusic.pause(); musicToggle.textContent = 'Play Music'; }
      });
    }
    // track whether last hit was a pipe (for blast image)
    let lastHitWasPipe = false;

    // Game state
    let frames = 0;
    let pipes = [];
    let coins = []; // active collectible coins
    let pipeSpawnCount = 0;
    let score = 0;
    let running = false; // true while physics running
    let started = false; // true after player starts the game
    let hasPlayed = false; // becomes true after first game over
    // speed controls
    const baseSpeed = 2.6;
    // hover animation speed control (ms)
    let hoverSlowMs = 900;
    let hoverFastMs = 180;
    let hoverCurrentMs = hoverSlowMs;
    const hoverLerp = 0.04;

    const bird = {
      x: 90,
      y: H/2,
      w: 48,
      h: 36,
      vy: 0,
      gravity: 0.35,
      jump: -6.5
    };
    const birdGravityDefault = bird.gravity;

    function startGame(){
      frames = 0; pipes = []; score = 0; document.getElementById('score').textContent = score;
      // clear any previous highlight of latest score when starting
      try{ const scoreSpan = document.getElementById('score'); if (scoreSpan) scoreSpan.classList.remove('score-highlight'); }catch(e){}
      bird.y = H/2; bird.vy = 0; running = true; started = true;
      // bird goes straight until first user flap: disable gravity until first flap
      bird.gravity = 0;
      // hide clear cache and bottom controls during running
      try{ if (clearCacheBtn) clearCacheBtn.style.display = 'none'; }catch(e){}
      try{ const bc = document.getElementById('bottom-controls'); if (bc) bc.style.display = 'none'; }catch(e){}
      // ensure action button is back in the overlay buttons area (centered)
      try{ const overlayBtns = document.querySelector('.overlay-buttons'); const actionBtn = document.getElementById('action-btn'); if (overlayBtns && actionBtn && actionBtn.parentNode !== overlayBtns){ overlayBtns.insertBefore(actionBtn, overlayBtns.firstChild); } }catch(e){}
      // hide submit while playing
      try{ const submit = document.getElementById('submit-score-btn'); if (submit) submit.style.display = 'none'; }catch(e){}
      // hide overlay
      const overlay = document.getElementById('overlay'); if (overlay) { overlay.style.display = 'none'; overlay.querySelector('#overlay-bird').src = defaultBirdSrc; }
      const lb = document.getElementById('leaderboard'); if (lb) lb.style.display = 'none';
      // restore bird image
      birdImg.src = defaultBirdSrc;
      lastHitWasPipe = false;
      // set action button to 'Restart' when playing, overlay will show it again on game over
      const actionBtn = document.getElementById('action-btn'); if (actionBtn) actionBtn.textContent = 'Restart';
    }

    function init(){
      // initial pre-start state
      frames = 0; pipes = []; score = 0; document.getElementById('score').textContent = score;
      try{ const scoreSpan = document.getElementById('score'); if (scoreSpan) scoreSpan.classList.remove('score-highlight'); }catch(e){}
      bird.y = H/2; bird.vy = 0; running = false; started = false;
      const overlay = document.getElementById('overlay'); if (overlay) { overlay.style.display = 'flex'; overlay.querySelector('#overlay-sub').textContent = 'Version 1.0'; }
      // randomize clouds and grass for each start screen
      try{ initClouds(); }catch(e){}
      try{ initGrass(); }catch(e){}
      // show clear cache and bottom controls on start screen
      try{ if (clearCacheBtn) clearCacheBtn.style.display = 'inline-block'; }catch(e){}
      try{ const bc = document.getElementById('bottom-controls'); if (bc) bc.style.display = 'flex'; }catch(e){}
      // ensure submit is hidden on start
      try{ const submit = document.getElementById('submit-score-btn'); if (submit) submit.style.display = 'none'; }catch(e){}
    }

    function spawnPipe(){
      const gap = 140;
      const minTop = 60;
      const maxTop = H - 200;
      const top = Math.floor(Math.random() * (maxTop - minTop)) + minTop;
      const pipe = {x: W, top: top, gap: gap, passed:false};
      pipes.push(pipe);
      // spawn coin only every 5 pipes, mostly centered
      try{
        pipeSpawnCount++;
        if (pipeSpawnCount % 5 === 0){
          const cx = W + 30;
          const centerY = top + gap/2;
          const offset = (Math.random() - 0.5) * gap * 0.15;
          const cy = centerY + offset;
          const size = 28 + Math.floor(Math.random()*8);
          const rot = Math.random() * Math.PI * 2;
          const rotSpeed = (Math.random() * 0.04 + 0.01) * (Math.random() < 0.5 ? -1 : 1);
          coins.push({x: cx, y: cy, size:size, rot:rot, rotSpeed:rotSpeed});
        }
      }catch(e){}
    }

    function onPipeHit(){
      // handle effects when hitting a pipe: blast image + sound + lower music volume
      lastHitWasPipe = true;
      try{
        // swap bird image to blast
        birdImg.src = blastBirdSrc;
        const overlay = document.getElementById('overlay');
        if (overlay) overlay.querySelector('#overlay-bird').src = blastBirdSrc;
        // play hit sound
        if (hitSnd){ try{ hitSnd.currentTime = 0; hitSnd.play().catch(()=>{}); }catch(e){} }
        // show blast at bird position for 1s
        try{
          explosion = { x: bird.x, y: bird.y, created: performance.now(), ttl: 1000 };
          setTimeout(()=>{ explosion = null; }, 1000);
        }catch(e){}
        // lower bg music temporarily
        if (bgMusic && !bgMusic.paused){
          const prev = bgMusic.volume;
          try{ bgMusic.volume = Math.max(0.02, prev * 0.25); }catch(e){}
          setTimeout(()=>{ try{ if (bgMusic) bgMusic.volume = prev; }catch(e){} }, 1500);
        }
        // finalize game over (show overlay with final score)
        gameOver();
      }catch(e){ console.warn('onPipeHit error', e); }
    }

    function gameOver(){
      running = false;
      started = false;
      hasPlayed = true;
      // ensure HUD shows final score and overlay displays it
      const scoreSpan = document.getElementById('score');
      if (scoreSpan) scoreSpan.textContent = score;
      const overlay = document.getElementById('overlay');
      if (overlay){
        overlay.style.display = 'flex';
        // show blast bird if pipe caused the hit
        overlay.querySelector('#overlay-bird').src = lastHitWasPipe ? blastBirdSrc : defaultBirdSrc;
        overlay.querySelector('#overlay-sub').innerHTML = 'Score: <span class="overlay-latest">' + score + '</span><br>(Valla panikk podaa)';
        try{ const scoreSpan = document.getElementById('score'); if (scoreSpan) scoreSpan.classList.add('score-highlight'); }catch(e){}
        // record score to leaderboard (name optional) and cache last score
        try{
          const nameInput = document.getElementById('player-name');
          const name = nameInput && nameInput.value.trim() ? nameInput.value.trim() : 'Player';
            addScoreToLeaderboard(name, score);
            // find the most recent matching entry we just added and cache it so highlighting is reliable
            try{
              const all = getStoredLeaderboard() || [];
              // find entries that match name & score, pick latest time
              let matches = all.filter(e => e.name === name && Number(e.score) === Number(score));
              let latest = null;
              if (matches.length > 0){
                latest = matches.reduce((a,b)=> (a.time > b.time ? a : b));
              }
              if (latest){
                try{ localStorage.setItem('flappy_lastScore', String(latest.score)); localStorage.setItem('flappy_lastName', latest.name); localStorage.setItem('flappy_lastTime', String(latest.time)); }catch(e){}
              }
            }catch(e){}
            renderLeaderboard();
          const lb = document.getElementById('leaderboard'); if (lb) lb.style.display = 'block';
          // show submit button and bottom controls on overlay now
          const submitBtnNow = document.getElementById('submit-score-btn'); if (submitBtnNow) submitBtnNow.style.display = 'inline-block';
          try{ const bc = document.getElementById('bottom-controls'); if (bc) bc.style.display = 'flex';
            // ensure Restart (actionBtn) is first, then How to play?, then GO Home (keeps swapped order)
            try{
              const actionBtn = document.getElementById('action-btn');
              const howtoBtn = document.getElementById('howto-btn');
              const homeBtn = document.getElementById('home-btn');
              if (actionBtn) bc.insertBefore(actionBtn, bc.firstChild);
              // place howto after actionBtn
              if (howtoBtn) bc.insertBefore(howtoBtn, actionBtn.nextSibling || null);
              // place home after howto
              if (homeBtn) bc.insertBefore(homeBtn, howtoBtn.nextSibling || null);
            }catch(e){}
          }catch(e){}
          // show clear cache on end screen
          try{ if (clearCacheBtn) clearCacheBtn.style.display = 'inline-block'; }catch(e){}
          const actionBtn = document.getElementById('action-btn'); if (actionBtn) actionBtn.textContent = 'Restart';
          try{ localStorage.setItem('flappy_lastScore', String(score)); localStorage.setItem('flappy_lastName', name); }catch(e){}
        }catch(e){ console.warn('leaderboard record error', e); }
      }
    }

    // ---------- Leaderboard helpers ----------
    const LB_KEY = 'flappy_leaderboard_v1';
    function getStoredLeaderboard(){
      try{ const raw = localStorage.getItem(LB_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; }
    }
    function storeLeaderboard(list){ try{ localStorage.setItem(LB_KEY, JSON.stringify(list)); }catch(e){}
    }
    function ensureDemoLeaderboard(){
      let cur = getStoredLeaderboard();
      if (!cur || !Array.isArray(cur) || cur.length === 0){
        cur = [
          {name:'Akshay', score:334, time:Date.now()-86400000},
          {name:'dfghg', score:271, time:Date.now()-3600000},
          {name:'kmrxz', score:102, time:Date.now()-600000},
          {name:'kenthan', score:6, time:Date.now()-300000},
          {name:'Alven', score:5, time:Date.now()-120000},
        ];
        storeLeaderboard(cur);
      }
      return cur;
    }
    function addScoreToLeaderboard(name, score){
      const cur = getStoredLeaderboard() || [];
      cur.push({name:name, score:score, time:Date.now()});
      cur.sort((a,b)=>b.score - a.score || a.time - b.time);
      // keep top 10
      const trimmed = cur.slice(0,10);
      storeLeaderboard(trimmed);
    }
    function renderLeaderboard(){
      ensureDemoLeaderboard();
      const list = getStoredLeaderboard() || [];
      const ol = document.getElementById('leaderboard-list');
      if (!ol) return;
      ol.innerHTML = '';
      const lastName = localStorage.getItem('flappy_lastName');
      const lastScore = localStorage.getItem('flappy_lastScore');
      const lastTime = localStorage.getItem('flappy_lastTime');
      list.forEach((entry, idx)=>{
        const li = document.createElement('li');
        li.textContent = `${entry.name} â€” ${entry.score}`;
        // prevent overflow: ellipsis if too long
        li.style.whiteSpace = 'nowrap';
        li.style.overflow = 'hidden';
        li.style.textOverflow = 'ellipsis';
        li.style.display = 'block';
        // default styling
        li.style.color = '';
        li.style.fontWeight = '';
        li.style.fontSize = '13px';
        // highlight latest updated score (from last play) in cyan if it matches
        try{
          if (lastTime && Number(entry.time) === Number(lastTime)){
            // highlight the exact leaderboard entry we just recorded
            li.style.color = 'cyan';
            li.style.fontWeight = '700';
          } else if (lastName && lastScore && entry.name === lastName && String(entry.score) === String(lastScore)){
            // fallback: if time not present, match by name+score
            li.style.color = 'cyan';
            li.style.fontWeight = '700';
          } else {
            // color and font-size for top 3 positions
            if (idx === 0){ li.style.color = 'red'; li.style.fontSize = 'clamp(16px, 2.2vw, 22px)'; li.style.fontWeight = '700'; }
            else if (idx === 1){ li.style.color = 'orange'; li.style.fontSize = 'clamp(15px, 2.0vw, 20px)'; li.style.fontWeight = '700'; }
            else if (idx === 2){ li.style.color = 'yellow'; li.style.fontSize = 'clamp(14px, 1.8vw, 18px)'; li.style.fontWeight = '700'; }
          }
        }catch(e){}
        ol.appendChild(li);
      });
    }

    function update(){
      frames++;
      // spawn pipes every ~90 frames
      if (frames % 90 === 0) spawnPipe();

      // bird physics
      bird.vy += bird.gravity;
      bird.y += bird.vy;

      // ground/ceiling
      if (bird.y + bird.h/2 >= H){ lastHitWasPipe = false; gameOver(); }
      if (bird.y - bird.h/2 <= 0){ bird.y = bird.h/2; bird.vy = 0; }

      // speed increases gradually with time (grows a bit faster now)
      const speed = baseSpeed + Math.min(4, frames * 0.0008);

      // cloud/grass movement handled in bgUpdate() which runs every frame
      for (let i = pipes.length-1; i >= 0; i--){
        const p = pipes[i];
        p.x -= speed;
        // passed
        if (!p.passed && p.x + 40 < bird.x){ p.passed = true; score++; document.getElementById('score').textContent = score; }
        // remove offscreen
        if (p.x + 60 < 0) pipes.splice(i,1);
        // collision box check
        const bx = bird.x, by = bird.y, bw = bird.w, bh = bird.h;
        const pipeW = 60;
        if (bx + bw/2 > p.x && bx - bw/2 < p.x + pipeW){
          if (by - bh/2 < p.top || by + bh/2 > p.top + p.gap){
            // hit a pipe
            onPipeHit();
          }
        }
      }
      // coins movement and collection
      for (let i = coins.length-1; i >= 0; i--){
        const c = coins[i];
        c.x -= speed;
        c.rot += c.rotSpeed;
        // collision check with bird (circle-based)
        const dx = c.x - bird.x;
        const dy = c.y - bird.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const radius = (c.size/2) + Math.max(bird.w,bird.h)/3;
        if (dist < radius){
          try{ if (coinSnd){ coinSnd.currentTime = 0; coinSnd.play().catch(()=>{}); } }catch(e){}
          score += 5; document.getElementById('score').textContent = score;
          coins.splice(i,1);
          continue;
        }
        if (c.x + c.size < 0) coins.splice(i,1);
      }
    }

    function draw(){
      // background
      ctx.clearRect(0,0,W,H);
      // sky gradient
      const g = ctx.createLinearGradient(0,0,0,H);
      g.addColorStop(0,'#092434'); g.addColorStop(1,'#02121a');
      ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

      // clouds (behind pipes)
      try{
        clouds.forEach(c=>{
          if (c.img && c.img.complete){
            ctx.save(); ctx.globalAlpha = c.alpha || 0.7; ctx.drawImage(c.img, c.x, c.y, c.w, c.h); ctx.restore();
          }
        });
      }catch(e){}

      // pipes
      ctx.fillStyle = '#0a5f3a';
      pipes.forEach(p=>{
        ctx.fillRect(p.x, 0, 60, p.top);
        ctx.fillRect(p.x, p.top + p.gap, 60, H - (p.top + p.gap));
        // pipe caps
        ctx.fillStyle = '#0c6f46';
        ctx.fillRect(p.x-2, p.top - 8, 64, 8);
        ctx.fillRect(p.x-2, p.top + p.gap, 64, 8);
        ctx.fillStyle = '#0a5f3a';
      });

      // draw coins (after pipes so they're visible in gaps)
      try{
        const coinImg = window._flappy_coinImg;
        coins.forEach(c=>{
          ctx.save();
          ctx.translate(c.x, c.y);
          ctx.rotate(c.rot);
          const s = c.size;
          if (coinImg && coinImg.complete){ ctx.drawImage(coinImg, -s/2, -s/2, s, s); }
          else { ctx.fillStyle = '#ffd700'; ctx.beginPath(); ctx.arc(0,0,s/2,0,Math.PI*2); ctx.fill(); }
          ctx.restore();
        });
      }catch(e){}

      // bird
      ctx.save();
      const bx = bird.x - bird.w/2, by = bird.y - bird.h/2;
      if (birdLoaded){
        ctx.drawImage(birdImg, bx, by, bird.w, bird.h);
      } else {
        // fallback: circle
        ctx.fillStyle = '#ffd166'; ctx.beginPath(); ctx.arc(bird.x, bird.y, 16,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();

      // draw explosion (if any) on top
      if (explosion && explosionImgLoaded){
        const now = performance.now();
        const age = now - explosion.created;
        const ttl = explosion.ttl || 1000;
        const alpha = Math.max(0, 1 - (age / ttl));
        ctx.save();
        ctx.globalAlpha = alpha;
        const exSize = 64;
        ctx.drawImage(explosionImg, explosion.x - exSize/2, explosion.y - exSize/2, exSize, exSize);
        ctx.restore();
      }

      // grasses on ground (draw before ground overlay)
      try{
        for (let i = 0; i < grasses.length; i++){
          const g = grasses[i];
          if (g.img && g.img.complete){ ctx.drawImage(g.img, g.x, g.y, g.w, g.h); }
          else { ctx.fillStyle = '#1a5a2a'; ctx.fillRect(g.x, g.y, g.w, g.h); }
        }
      }catch(e){}

      // ground
      ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.fillRect(0,H-20,W,20);

      if (!running){
        // keep drawing background but show overlay DOM for game over / restart info
        const overlay = document.getElementById('overlay');
        if (overlay){
            overlay.style.display = 'flex';
            if (typeof hasPlayed !== 'undefined' && hasPlayed){
              overlay.querySelector('#overlay-sub').innerHTML = 'Score: ' + score + '<br>(Valla panikk podaa)';
            } else {
              overlay.querySelector('#overlay-sub').textContent = 'Version 1.0';
            }
        } else {
            ctx.fillStyle = 'rgba(0,0,0,0.45)'; ctx.fillRect(0,0,W,H);
            ctx.fillStyle = '#fff'; ctx.font = '24px Arial'; ctx.textAlign = 'center';
            ctx.fillText('Game Over', W/2, H/2 - 24);
            ctx.fillText('(VALLA PANIKK PODA) Click or press Space to restart', W/2, H/2 + 8);
            ctx.fillText('Score: ' + score, W/2, H/2 + 44);
        }
      }
    }

    // update background elements (clouds + grass) every frame so they animate even on start/menu
    function bgUpdate(){
      // clouds move at their own speed
      try{
        for (let i = 0; i < clouds.length; i++){
          const c = clouds[i];
          c.x -= c.speed * (running ? 1 : 0.6);
          if (c.x + (c.w || 200) < 0){
            c.x = W + Math.random() * 300;
            c.y = 10 + Math.random() * 260;
            c.w = 160 + Math.floor(Math.random() * 260);
            c.h = Math.floor(c.w * 0.45);
            c.speed = 0.15 + Math.random() * 1.0;
            c.img = cloudImgs[Math.floor(Math.random() * cloudImgs.length)];
            c.alpha = 0.45 + Math.random() * 0.45;
          }
        }
      }catch(e){}

      // grasses move with world speed (slower on menu)
      try{
        const bgSpeed = running ? (baseSpeed + Math.min(4, frames * 0.0008)) : (baseSpeed * 0.35);
        for (let i = 0; i < grasses.length; i++){
          const g = grasses[i];
          g.x -= bgSpeed * (g.speedFactor || 1);
          if (g.x + g.w < 0){
            g.x = W + Math.random() * 300;
            g.w = 48 + Math.floor(Math.random() * 80);
            g.h = Math.floor(g.w * 0.45);
            g.y = H - 20 - g.h + (Math.random() * 6 - 3);
            g.img = grassImgs[Math.floor(Math.random() * grassImgs.length)];
            g.speedFactor = 0.9 + Math.random() * 0.3;
          }
        }
      }catch(e){}
      // smoothly interpolate hover animation duration toward target.
      // When overlay is visible (start/restart) keep it slow; when playing,
      // reduce duration proportionally as game speed increases for a smooth effect.
      try{
        const overlay = document.getElementById('overlay');
        const overlayVisible = overlay && getComputedStyle(overlay).display !== 'none';
        let target;
        if (overlayVisible){
          target = hoverSlowMs; // slow on menus
        } else {
          // map current game speed to a 0..1 range based on extra speed cap (4)
          const currentGameSpeed = baseSpeed + Math.min(4, frames * 0.0008);
          const t = Math.min(1, Math.max(0, (currentGameSpeed - baseSpeed) / 4));
          // interpolate between slow and fast durations based on game speed
          target = hoverSlowMs + (hoverFastMs - hoverSlowMs) * t;
        }
        hoverCurrentMs += (target - hoverCurrentMs) * hoverLerp;
        // set CSS var used by transitions (clamp to a sensible minimum)
        document.documentElement.style.setProperty('--hover-speed', Math.max(60, hoverCurrentMs) + 'ms');
      }catch(e){}
    }

    function loop(){
      bgUpdate();
      if (running) update();
      draw();
      requestAnimationFrame(loop);
    }

    // controls
    function flap(){
      // Only allow flapping while the game is running.
      if (!running) return;
      // if gravity was disabled at start, enable it on first flap
      if (!bird.gravity || bird.gravity === 0){ bird.gravity = birdGravityDefault; }
      bird.vy = bird.jump;
    }
    function tryPlayTap(){ if (tapSnd){ try{ tapSnd.currentTime = 0; tapSnd.play().catch(()=>{}); }catch(e){} } }
    window.addEventListener('keydown', (e)=>{ if (e.code === 'Space') { e.preventDefault(); if (running){ tryPlayTap(); flap(); } }});
    canvas.addEventListener('click', ()=>{ if (running){ tryPlayTap(); flap(); } });
    canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); if (running){ tryPlayTap(); flap(); } }, {passive:false});

    // button audio helpers
    const btnStartSnd = document.getElementById('btnStartSnd');
    const btnOtherSnd = document.getElementById('btnOtherSnd');
    function tryPlayStart(){ if (btnStartSnd){ try{ btnStartSnd.currentTime = 0; btnStartSnd.play().catch(()=>{}); }catch(e){} } }
    function tryPlayOther(){ if (btnOtherSnd){ try{ btnOtherSnd.currentTime = 0; btnOtherSnd.play().catch(()=>{}); }catch(e){} } }

    // wire up overlay buttons
    const actionBtn = document.getElementById('action-btn');
    if (actionBtn){ actionBtn.addEventListener('click', ()=>{ tryPlayStart(); // start or restart only via this button
      startGame(); }); }
    const submitBtn = document.getElementById('submit-score-btn');
    if (submitBtn){ submitBtn.addEventListener('click', (ev)=>{
      tryPlayOther();
      ev.preventDefault();
      try{
        // auto-fill hidden form and submit (opens in new tab)
        const nameInput = document.getElementById('player-name');
        const name = nameInput && nameInput.value.trim() ? nameInput.value.trim() : (localStorage.getItem('flappy_lastName') || 'Player');
        const last = localStorage.getItem('flappy_lastScore');
        const lastScore = (last !== null) ? last : String(score);
        const fName = document.getElementById('form-name');
        const fScore = document.getElementById('form-highscore');
        if (fName) fName.value = name;
        if (fScore) fScore.value = lastScore;
        const form = document.getElementById('score-form');
        if (form) form.submit();
      }catch(e){ console.warn('submit score error', e); }
    }); }

    // ensure demo leaderboard exists on load
    try{ ensureDemoLeaderboard(); renderLeaderboard(); }catch(e){}
    // hide submit button on start
    try{ const submitInit = document.getElementById('submit-score-btn'); if (submitInit) submitInit.style.display = 'none'; }catch(e){}

    // wrap buttons' inner contents with a span so CSS hover and JS transforms combine
    function wrapButtons(){
      try{
        const btns = Array.from(document.querySelectorAll('button'));
        btns.forEach(b=>{
          if (!b.classList.contains('btn-base')) b.classList.add('btn-base');
          // don't double-wrap
          if (!b.querySelector('.btn-inner')){
            const inner = document.createElement('span');
            inner.className = 'btn-inner';
            // move existing children into inner
            while (b.firstChild) inner.appendChild(b.firstChild);
            b.appendChild(inner);
          }
        });
      }catch(e){}
    }
    wrapButtons();

    // persist player name: load and save
    try{
      const nameInput = document.getElementById('player-name');
      const cached = localStorage.getItem('flappy_lastName');
      if (nameInput && cached) nameInput.value = cached;
      if (nameInput){ nameInput.addEventListener('input', (e)=>{ try{ localStorage.setItem('flappy_lastName', nameInput.value); }catch(ee){} }); }
    }catch(e){}

    // bottom controls and dialog handlers
    try{
      const bottomControls = document.getElementById('bottom-controls');
      const homeBtn = document.getElementById('home-btn');
      const howtoBtn = document.getElementById('howto-btn');
      const howtoDialog = document.getElementById('howto-dialog');
      const understoodBtn = document.getElementById('understood-btn');
      if (homeBtn) homeBtn.addEventListener('click', ()=>{ tryPlayOther(); location.href = 'index.html'; });
      if (howtoBtn) howtoBtn.addEventListener('click', ()=>{ tryPlayOther(); if (howtoDialog) howtoDialog.style.display = 'block'; });
      if (understoodBtn) understoodBtn.addEventListener('click', ()=>{ tryPlayOther(); if (howtoDialog) howtoDialog.style.display = 'none'; });
      // show bottom controls on start and end, hide during gameplay
      try{ if (bottomControls) bottomControls.style.display = 'flex'; }catch(e){}
    }catch(e){}

    // preload coin image for drawing
    try{
      const coinImg = new Image(); coinImg.src = 'images/coin.png'; window._flappy_coinImg = coinImg;
    }catch(e){}

    // clear cache button handler (visible on every screen)
    try{
      if (clearCacheBtn){ clearCacheBtn.addEventListener('click', ()=>{
        try{
          tryPlayOther();
          localStorage.removeItem(LB_KEY);
          localStorage.removeItem('flappy_lastScore');
          localStorage.removeItem('flappy_lastName');
          localStorage.removeItem('flappy_lastTime');
          // show toast then reload
          showToast('Cache cleared');
          setTimeout(()=>{ location.reload(); }, 800);
        }catch(e){ console.warn('clear cache error', e); }
      }); }
    }catch(e){}

    // toast helper
    function showToast(msg){
      try{
        const t = document.createElement('div');
        t.textContent = msg;
        t.style.position = 'fixed';
        t.style.left = '50%'; t.style.bottom = '24px';
        t.style.transform = 'translateX(-50%)';
        t.style.background = 'rgba(0,0,0,0.75)';
        t.style.color = '#fff'; t.style.padding = '8px 12px'; t.style.borderRadius = '8px';
        t.style.zIndex = 9999; t.style.fontSize = '13px';
        document.body.appendChild(t);
        setTimeout(()=>{ t.style.transition = 'opacity 300ms'; t.style.opacity = '0'; }, 600);
        setTimeout(()=>{ try{ t.remove(); }catch(e){} }, 1000);
      }catch(e){}
    }

    // start (show pre-start overlay)
    init(); loop();
  </script>
</body>
</html>

